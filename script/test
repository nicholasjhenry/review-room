#!/usr/bin/env bash
#
# script/test: Test setup and archive of worktree.
#              Run script/test for usage.

set -e

cd "$(dirname "$0")/.."

WORKSPACE_NAME="${CONDUCTOR_WORKSPACE_NAME:-workspace_demo}"
BASE_PORT="${CONDUCTOR_PORT:-55100}"
WORKSPACE_DIR=".conductor/demo"
BRANCH_NAME="demo"
BASE_BRANCH="${2:-develop}"

usage() {
    echo "Usage: $0 {setup|archive} [base_branch]"
    echo ""
    echo "Commands:"
    echo "  setup [base_branch]  - Create and set up a test workspace"
    echo "                         (default base branch: develop)"
    echo "  archive              - Archive and remove the test workspace"
    echo ""
    echo "Examples:"
    echo "  $0 setup              # Creates workspace from 'develop' branch"
    echo "  $0 setup main         # Creates workspace from 'main' branch"
    echo "  $0 archive            # Removes the test workspace"
    exit 1
}

setup_workspace() {
    echo "Setting up test workspace..."

    # Create workspace directory
    mkdir -p .conductor

    # Export environment variables
    export CONDUCTOR_WORKSPACE_NAME="$WORKSPACE_NAME"
    export CONDUCTOR_PORT="$BASE_PORT"

    echo "Environment variables set:"
    echo "  CONDUCTOR_WORKSPACE_NAME=$CONDUCTOR_WORKSPACE_NAME"
    echo "  CONDUCTOR_PORT=$CONDUCTOR_PORT"

    # Create git worktree
    echo "Creating git worktree at $WORKSPACE_DIR..."
    git worktree add -b "$BRANCH_NAME" "$WORKSPACE_DIR" "$BASE_BRANCH"

    # Change to workspace directory and run setup
    cd "$WORKSPACE_DIR"

    echo "Running worktree setup..."
    script/worktree

    echo "Running workspace setup..."
    script/setup

    echo ""
    echo "✓ Workspace setup complete!"
    echo ""
    echo "To use this workspace:"
    echo "  cd $WORKSPACE_DIR"
    echo "  script/server"
}

archive_workspace() {
    echo "Archive up test workspace..."

    # Export environment variables for archive script
    export CONDUCTOR_WORKSPACE_NAME="$WORKSPACE_NAME"
    export CONDUCTOR_PORT="$BASE_PORT"

    # Run archive script if in workspace directory
    if [ -d "$WORKSPACE_DIR" ]; then
        cd "$WORKSPACE_DIR"
        echo "Running archive script..."
        script/archive
        cd ../..
    fi

    # Unset environment variables
    unset CONDUCTOR_WORKSPACE_NAME
    unset CONDUCTOR_PORT

    echo "Removing git worktree..."
    git worktree remove "$WORKSPACE_DIR" 2>/dev/null || true

    echo "Deleting branch..."
    git branch -D "$BRANCH_NAME" 2>/dev/null || true

    echo ""
    echo "✓ Workspace archive complete!"
}

# Main script
case "${1:-}" in
setup)
    setup_workspace
    ;;
archive)
    archive_workspace
    ;;
*)
    usage
    ;;
esac
